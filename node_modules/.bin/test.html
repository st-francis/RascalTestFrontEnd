<!doctype html>
<html lang="en">

<head>
  <meta charset=utf8>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>A new method towards Choreographic Programming</title>
  <style>
    body,
    html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .top,
    .middle {
      width: 50%;
      float: left;
    }

    .button-container,
    #button-container2 {
      text-align: center;
      margin-top: 20px;
    }

    .button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .result-container {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .result {
      width: 50%;
      border: 1px solid #dddddd;
      background-color: #f0f0f0;
      border-radius: 15px;
      padding: 25px;
      box-sizing: border-box;
    }

    #loader {
      border: 8px solid #f3f3f3;
      border-radius: 50%;
      border-top: 8px solid #3498db;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
    }


    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <h1 style="padding: 10px;">A new method towards Choreographic Programming</h1>

  <script src="editor.bundle.js"></script>

  <div class="button-container">
    <button class="button" onclick="saveAndProjectChoreography()">Save and project choreography</button>
    <!-- <button class="button" id="getDataButton">Project choreography</button> -->
  </div>

  <div class="result-container">
    <div class="result">
      <h2>Projection summary</h2>
      <div style="display: none;" id="loader"></div>
      <p id="header1"></p>
      <p id="result1"></p>
      <p id="result2"></p>
      <p id="result3"></p>
      <p id="header2"></p>
      <p id="result4"></p>
      <p id="result5"></p>
      <p id="result6"></p>
    </div>
  </div>

  <script>
    var fileLocation = "";

    async function saveAndProjectChoreography() {      

      saveFile().then(async () => {
        console.log("in then!");
        fileLocation = "M:/RascalTestNew/rascaltest/src/main/rascal/PoC/FrontEnd/node_modules/.bin/choreography.choreo";
        await getData();
      }).catch(error => {
        console.error('Error saving file:', error);
      });
    }

    function saveFile() {
        return new Promise((resolve, reject) => {
          const element = document.querySelector(".cm-content");
          var textToWrite = element.innerText;
          console.log(element);
          console.log(textToWrite);
          // Trigger click event to download the file
            var textToWrite = textToWrite.replace(/\n/g, "\r\n");
          var textFileAsBlob = new Blob([textToWrite], { type: 'text/plain' });
          var fileNameToSaveAs = "choreography.choreo";
          var downloadLink = document.createElement("a");
          downloadLink.download = fileNameToSaveAs;
          downloadLink.innerHTML = "LINKTITLE";
          window.URL = window.URL || window.webkitURL;
          downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
          downloadLink.onclick = destroyClickedElement;
          downloadLink.style.display = "none";
          document.body.appendChild(downloadLink);

          // Check if the file is saved
          downloadLink.addEventListener('click', function () {

            setTimeout(() => {
              resolve();
            }, 2000);

            // console.log("resolved!");
            // resolve();
          });

          downloadLink.click();

        });
      }

    function destroyClickedElement(event) {
        document.body.removeChild(event.target);
      }
    
    async function getData()
    {
      console.log("Getting data!");
       if (fileLocation.length == 0) {
        alert('Please first save the choreography!');
        return;
      }

      toggleLoader();

      // Make an HTTP GET request when the button is clicked
      try {
        console.log('Entering fetch!');
        const response = await fetch('http://localhost:3000/api/data');

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();

        var deadlockFreeColor = getColor(data.isDeadlockFree);
        var isEquivalentColor = getColor(data.areLTSsEquivalent);

        console.log(data); // Display the received data in the console
        document.getElementById('header1').innerHTML = "<strong>Choreography LTS</strong>";
        document.getElementById('result1').innerHTML = "Transitions: " + data.choreographyTransitions;
        document.getElementById('result2').innerHTML = "States: " + data.choreographyStates;
        document.getElementById('result3').innerHTML = "Is deadlock-free: " + "<strong style='color:"+ deadlockFreeColor + "'>" + data.isDeadlockFree + "</strong>";
        document.getElementById('header2').innerHTML = "<strong>Process composition LTS</strong>";
        document.getElementById('result4').innerHTML = "Transitions: " + data.processTransitions;
        document.getElementById('result5').innerHTML = "States: " + data.processStates;
        document.getElementById('result6').innerHTML = "Transition systems functionally equivalent: " + "<strong style='color:" + isEquivalentColor + "'>" + data.areLTSsEquivalent + "</strong>";

        toggleLoader();

      } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
      }
    }

    function getColor(res) {
        if (res == 'true') {
          return 'green';
        }
        return 'red';
      }

    document.getElementById('getDataButton').addEventListener('click', async () => {
      if (fileLocation.length == 0) {
        alert('Please first save the choreography!');
        return;
      }

      toggleLoader();

      // Make an HTTP GET request when the button is clicked
      try {
        console.log('Entering fetch!');
        const response = await fetch('http://localhost:3000/api/data');

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        console.log(data); // Display the received data in the console
        document.getElementById('result1').innerHTML = "Choreography LTS deadlock-free:" + data.isDeadlockFree;
        document.getElementById('result2').innerHTML = "Transition systems functionally equivalent:" + data.areLTSsEquivalent;
        
        toggleLoader();
  
      } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
      }
    });

    function toggleLoader() {
      var x = document.getElementById("loader");
      if (x.style.display === "none") {
        console.log('changing display');
        x.style.display = "block";
      } else {
        console.log('changing display');
        x.style.display = "none";
      }
    }

  </script>
</body>

</html>